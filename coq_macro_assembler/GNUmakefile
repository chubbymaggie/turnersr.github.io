include Makefile.common

VS_BACKSLASH := $(TARGETS:%.vo=%.v)
VS := $(subst \,/,$(VS_BACKSLASH))

PWD := $(shell pwd)

# Careful: the order matters...
LIBS := ./contribs                 \
	./contribs/ATBR            \
	.                          \
	./charge                   \
	./$(ARCH)                  \
	./$(ARCH)/win              \
	./$(ARCH)/lib/regexp

COQLIBS := $(patsubst %,-I %, $(LIBS))
COQPROGARGS := $(patsubst %,\"$(abspath $(addprefix $(PWD)/,%))\", $(LIBS))

%.dll %.exe: %.v
	./buildexe.sh $< $@ $(COQLIBS)

default: all

Makefile.coq: GNUmakefile Makefile.common $(VS)
	coq_makefile $(COQLIBS) $(VS) -o Makefile.coq

.dir-locals.el:
	echo ";; Automatically generated by GNUmakefile." > .dir-locals.el; \
	echo "((coq-mode . ((coq-load-path . ($(COQPROGARGS))))))" >> .dir-locals.el

include Makefile.coq
