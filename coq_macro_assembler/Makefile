# This file defines ARCH, INCLUDES, TARGETS and EXETARGETS
!INCLUDE Makefile.common

# Set the flags for coqc here  
COQFLAGS=-dont-load-proofs
COQC=coqc $(COQFLAGS)
COQTOP=coqtop $(COQFLAGS)
HEXBIN=x86\bin\hexbin

ALLINCLUDES = $(INCLUDES);contribs;contribs/ATBR

# Turn ";"-separated sequence into appropriate syntax for coq command-line
COQINCLUDES=-I $(ALLINCLUDES:;= -I )
COQPROGARGS="$(ALLINCLUDES:;=" ")"

all: $(TARGETS) $(EXETARGETS)

show:
  @echo ARCH=$(ARCH)
  @echo INCLUDES=$(INCLUDES)
  @echo ALLINCLUDES=$(ALLINCLUDES)
  @echo TARGETS=$(TARGETS)
  @echo EXETARGETS=$(EXETARGETS)
  @echo COQINCLUDES=$(COQINCLUDES)
  @echo COQPROGARGS=$(COQPROGARGS)

clean: 
  @echo off
#  for %D IN ($(INCLUDES)) DO (del %%D\*.vo %%D\*.dep %%D\*.glob %%D\*.exe %%D\*.dll %%D\*.hex)
  del *.vo *.dep *.glob *.exe *.dll *.hex
  del x86\*.vo x86\*.dep x86\*.glob x86\*.exe x86\*.dll x86\*.hex
  del charge\*.vo charge\*.dep charge\*.glob charge\*.exe charge\*.dll charge\*.hex
  del x86\win\*.vo x86\win\*.dep x86\win\*.glob x86\win\*.exe x86\win\*.dll x86\win\*.hex
  del x86\lib\regexp\*.vo x86\lib\regexp\*.dep x86\lib\regexp\*.glob x86\lib\regexp\*.exe x86\lib\regexp\*.dll x86\lib\regexp\*.hex

# clear existing list first
.SUFFIXES: 
.SUFFIXES: .dll .exe .vo .dep .v .hex 

.v.vo:
	$(COQC) $(COQINCLUDES) $<

.v.hex: 
        $(COQTOP) -quiet -batch $(COQINCLUDES) -l $< >$*.hex

# The syntax #@ refers to the full target name (.exe file), $< refers to the dependent (.hex file)
.hex.exe:
        $(HEXBIN) $< $@

.hex.dll:
        $(HEXBIN) $< $@

Makefile.deps: $(TARGETS:.vo=.dep)
	@type $** > $@ 2>NUL

# Not sure how to get these automatically
x86/win/winfact.exe: x86/win/winfact.hex
x86/win/messagebox.exe: x86/win/messagebox.hex
x86/win/importer.exe: x86/win/importer.hex
x86/win/exporter.dll: x86/win/exporter.hex
x86/win/helloworld.exe: x86/win/helloworld.hex

.v.dep:
	coqdep $(COQINCLUDES) $< > $@

dirlocals:
	echo ;; Automatically generated by GNUmakefile. > .dir-locals.el
	echo ((coq-mode . ((coq-load-path . ($(COQPROGARGS)))))) >> .dir-locals.el


!IF EXIST (Makefile.deps)
!INCLUDE Makefile.deps
!ENDIF



